<!DOCTYPE html>
<html lang="en-US">
<meta charset="UTF-8">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <style type="text/css">
        
        .chart text {
            fill: black;
            font: 12px sans-serif ;
            text-anchor: start;
        }
        
        .textContainer {
            fill-opacity:0.4;
            stroke-width: 0.5;
            stroke: green;
        }
        
        .android{
          fill: rgb(253,127,0);
        }
        
        .desktop{
          fill: rgb(255,255,51);
        }
        
        .ipad{
          fill: rgb(153,153,153);
        }
        
        .mac{
          fill: rgb(247,129,191);
        }
        
        .online{
          fill: rgb(55,126,184);
        }
        
        .universal{
          fill: rgb(228,26,28);
        }
        
        .axis text {
          font: 10px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

    </style>
</head>
<body>
    <svg class="chart"></svg>
    <script>

        var margin = {top: 100, right: 20, bottom: 30, left: 40};
        var width = 600 - margin.left - margin.right;
        var barHeight = 20;
 
        var x = d3.scale.linear()
            .domain([0, 110])
            .range([1,width]);
            
        var xAxis = d3.svg.axis()
          .scale(x)
          .orient("top");
            
        var chart = d3.select(".chart")
            .attr("width", width)
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
        var legend = chart.append("g")
        legend.append("rect")
          .attr("width", "70")
          .attr("height", barHeight - 1)
          .attr("class", "android")
          .attr("transform", "translate(0, -40)");
          
       legend.append("text")
          .attr("x", 4)
          .attr("y", -31)
          .attr("dy", ".35em")
          .text("android");
          
        legend.append("rect")
          .attr("width", "70")
          .attr("height", barHeight - 1)
          .attr("class", "desktop")
          .attr("transform", "translate(80, -40)");
          
        legend.append("text")
          .attr("x", 84)
          .attr("y", -31)
          .attr("dy", ".35em")
          .text("desktop");
          
        legend.append("rect")
          .attr("width", "70")
          .attr("height", barHeight - 1)
          .attr("class", "ipad")
          .attr("transform", "translate(160, -40)");
          
        legend.append("text")
          .attr("x", 164)
          .attr("y", -31)
          .attr("dy", ".35em")
          .text("ipad");
          
         legend.append("rect")
          .attr("width", "70")
          .attr("height", barHeight - 1)
          .attr("class", "mac")
          .attr("transform", "translate(240, -40)");
          
         legend.append("text")
          .attr("x", 244)
          .attr("y", -31)
          .attr("dy", ".35em")
          .text("mac");
          
         legend.append("rect")
          .attr("width", "70")
          .attr("height", barHeight - 1)
          .attr("class", "online")
          .attr("transform", "translate(320, -40)");
          
         legend.append("text")
          .attr("x", 324)
          .attr("y", -31)
          .attr("dy", ".35em")
          .text("online");
          
         legend.append("rect")
          .attr("width", "70")
          .attr("height", barHeight - 1)
          .attr("class", "universal")
          .attr("transform", "translate(400, -40)");
          
        legend.append("text")
          .attr("x", 404)
          .attr("y", -31)
          .attr("dy", ".35em")
          .text("universal");
                    
        d3.json('data2.json', function(error, root){
            if(error) throw error;
            
            var focus = root,
              nodes = classes(root);
              
            chart.attr("height", barHeight * nodes.children.length);

            var bar = chart.selectAll("g")
                .data(nodes.children)
            .enter().append("g")
                .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });
                
            bar.append("rect")
                .attr("width", function(d) { return x(d.value); })
                .attr("height", barHeight - 1)
                .attr("class", function(d) {return "bar " + d.subject;})
                
            bar.append("text")
                .attr("x", function(d) { return x(d.value) - 3; })
                .attr("y", barHeight / 2)
                .attr("dy", ".35em")
                .text(function(d) { return "Votes: " + d.value + ": " + d.name; })
                .on("click", function(d) {window.open(d.link);});
            
            bar.append("rect")
                .attr("x", function(d) { return x(d.value) - 3; })
                .attr("width", function(d){return width - x(d.value);})
                .attr("height", barHeight - 1)
                .attr("class", "textContainer")
                .on("click", function(d) {window.open(d.link);});  
       }); 

       // Returns a flattened hierarchy containing all leaf nodes under the root.
      function classes(root) {
        var classes = [];
      
        function recurse(name, node) {
          if (node.children) node.children.forEach(function(child) { recurse(node.name, child); });
          else classes.push({subject: name, name: node.name, value: node.votes, link: node.url});
        }
      
        recurse(null, root);
        classes.sort(function(a,b) {
          return parseInt(b.value) - parseInt(a.value);
        });
  
      return {children: classes};
    }
    </script>
</body>
</html>